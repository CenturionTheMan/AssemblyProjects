#include <iostream>
#include <sstream>
#include <random>
#include <chrono>
#include <limits>
#include <fstream>

struct Vector4
{
    float nums[4];

    Vector4() {}

    Vector4(float sub3, float sub2, float sub1, float sub0)
    {
        this->nums[3] = sub3;
        this->nums[2] = sub2;
        this->nums[1] = sub1;
        this->nums[0] = sub0;
    }

    std::string ToString()
    {
        std::stringstream stream;
        stream.precision(2);
        stream << nums[3] << "|" << nums[2] << "|" << nums[1] << "|" << nums[0] << std::endl;
        return stream.str();
    }
};

#pragma region SIMD

Vector4 SIMDadd(Vector4 v1 ,Vector4 v2, long &timeTaken)
{
    Vector4 result;
    
    auto start = std::chrono::high_resolution_clock::now();
    asm volatile (
        "movups %1, %%xmm0\n"
        "movups %2, %%xmm1\n"
        "addps %%xmm1, %%xmm0\n"
        "movups %%xmm0, %0"
        : "=m" (result.nums)
        : "m" (v1.nums), "m" (v2.nums)
        : "xmm1", "xmm0"
    );
    auto stop = std::chrono::high_resolution_clock::now();
    timeTaken += std::chrono::duration_cast<std::chrono::nanoseconds>(stop - start).count();

    return result;
}

Vector4 SIMDsub(Vector4 v1 ,Vector4 v2, long &timeTaken)
{
    Vector4 result;

    auto start = std::chrono::high_resolution_clock::now();
    asm volatile (
        "movups %1, %%xmm0\n"
        "movups %2, %%xmm1\n"
        "subps %%xmm1, %%xmm0\n"
        "movups %%xmm0, %0"
        : "=m" (result.nums)
        : "m" (v1.nums), "m" (v2.nums)
        : "xmm1", "xmm0"
    );
    auto stop = std::chrono::high_resolution_clock::now();
    timeTaken += std::chrono::duration_cast<std::chrono::nanoseconds>(stop - start).count();

    return result;
}

Vector4 SIMDmul(Vector4 v1 ,Vector4 v2, long &timeTaken)
{
    Vector4 result;

    auto start = std::chrono::high_resolution_clock::now();
    asm volatile (
        "movups %1, %%xmm0\n"
        "movups %2, %%xmm1\n"
        "mulps %%xmm1, %%xmm0\n"
        "movups %%xmm0, %0"
        : "=m" (result.nums)
        : "m" (v1.nums), "m" (v2.nums)
        : "xmm1", "xmm0"
    );
    auto stop = std::chrono::high_resolution_clock::now();
    timeTaken += std::chrono::duration_cast<std::chrono::nanoseconds>(stop - start).count();

    return result;
}

Vector4 SIMDdiv(Vector4 v1 ,Vector4 v2, long &timeTaken)
{
    Vector4 result;

    auto start = std::chrono::high_resolution_clock::now();
    asm volatile (
        "movups %1, %%xmm0\n"
        "movups %2, %%xmm1\n"
        "divps %%xmm1, %%xmm0\n"
        "movups %%xmm0, %0"
        : "=m" (result.nums)
        : "m" (v1.nums), "m" (v2.nums)
        : "xmm1", "xmm0"
    );
    auto stop = std::chrono::high_resolution_clock::now();
    timeTaken += std::chrono::duration_cast<std::chrono::nanoseconds>(stop - start).count();

    return result;
}

#pragma endregion SIMD

#pragma region SISD
float SISDadd (float f1, float f2, long &timeTaken)
{
    float result;

    auto start = std::chrono::high_resolution_clock::now();
    asm volatile (
        "flds %1\n"
        "fadds %2\n"
        "fstps %0\n"
        : "=m" (result)
        : "m" (f1), "m" (f2)
    );
    auto stop = std::chrono::high_resolution_clock::now();
    timeTaken += std::chrono::duration_cast<std::chrono::nanoseconds>(stop - start).count();

    return result;
}

float SISDsub (float f1, float f2, long &timeTaken)
{
    float result;

    auto start = std::chrono::high_resolution_clock::now();
    asm volatile (
        "flds %1\n"
        "fsubs %2\n"
        "fstps %0\n"
        : "=m" (result)
        : "m" (f1), "m" (f2)
    );
    auto stop = std::chrono::high_resolution_clock::now();
    timeTaken += std::chrono::duration_cast<std::chrono::nanoseconds>(stop - start).count();

    return result;
}

float SISDmul (float f1, float f2, long &timeTaken)
{
    float result;

    auto start = std::chrono::high_resolution_clock::now();
    asm volatile (
        "flds %1\n"
        "fmuls %2\n"
        "fstps %0\n"
        : "=m" (result)
        : "m" (f1), "m" (f2)
    );
    auto stop = std::chrono::high_resolution_clock::now();
    timeTaken += std::chrono::duration_cast<std::chrono::nanoseconds>(stop - start).count();

    return result;
}

float SISDdiv (float f1, float f2, long &timeTaken)
{
    float result;

    auto start = std::chrono::high_resolution_clock::now();
    asm volatile(
        "flds %1\n"
        "fdivs %2\n"
        "fstps %0\n"
        : "=m" (result)
        : "m" (f1), "m" (f2)
    );
    auto stop = std::chrono::high_resolution_clock::now();
    timeTaken += std::chrono::duration_cast<std::chrono::nanoseconds>(stop - start).count();


    return result;
}

#pragma endregion SISD

Vector4 GenerateRandomVector4(float min, float max)
{
    std::random_device rd;
    std::default_random_engine engine(rd());
    std::uniform_real_distribution<float> dist(min, max);
    
    Vector4 result = Vector4(dist(engine),dist(engine),dist(engine),dist(engine));

    return result;
}

float GenerateRandomFloat(float min, float max)
{
    std::random_device rd;
    std::default_random_engine engine(rd());
    std::uniform_real_distribution<float> dist(min, max);
    return dist(engine);
}

std::string PerformTestsSIMD(int numbersAmount, int repsAmount, float maxNumberInVector, float minNumberInVector)
{
    long addTime = 0;
    long subTime = 0;
    long mulTime = 0;
    long divTime = 0;

    for (int i = 0; i < repsAmount; i++)
    {
        for (int j = 0; j < numbersAmount/4/2; j++)
        {
            Vector4 v1 = GenerateRandomVector4(minNumberInVector, maxNumberInVector);
            Vector4 v2 = GenerateRandomVector4(minNumberInVector, maxNumberInVector);

            SIMDadd(v1, v2, addTime);
            SIMDsub(v1, v2, subTime);
            SIMDmul(v1, v2, mulTime);
            SIMDdiv(v1, v2, divTime);
        }
    }
    
    addTime /= repsAmount;
    subTime /= repsAmount;
    mulTime /= repsAmount;
    divTime /= repsAmount;

    std::stringstream result;
    result  << "Typ obliczen: SIMD\n" 
            << "Liczba liczb: " << numbersAmount << "\n"
            << "Sredni czas [ns]:\n" 
            << "+ " << addTime << "\n"
            << "- " << subTime << "\n"
            << "* " << mulTime << "\n"
            << "/ " << divTime << "\n";

    return result.str();
}

std::string PerformTestsSISD(int numbersAmount, int repsAmount, float maxNumberInVector, float minNumberInVector)
{
    long addTime = 0;
    long subTime = 0;
    long mulTime = 0;
    long divTime = 0;

    for (int i = 0; i < repsAmount; i++)
    {
        for (int j = 0; j < numbersAmount/2; j++)
        {
            float f1 = GenerateRandomFloat(minNumberInVector, maxNumberInVector);
            float f2 = GenerateRandomFloat(minNumberInVector, maxNumberInVector);

            SISDadd(f1, f2, addTime);
            SISDsub(f1, f2, subTime);
            SISDmul(f1, f2, mulTime);
            SISDdiv(f1, f2, divTime);
        }
    }
    
    addTime /= repsAmount;
    subTime /= repsAmount;
    mulTime /= repsAmount;
    divTime /= repsAmount;

    std::stringstream result;
    result  << "Typ obliczen: SISD\n" 
            << "Liczba liczb: " << numbersAmount << "\n"
            << "Sredni czas [ns]:\n" 
            << "+ " << addTime << "\n"
            << "- " << subTime << "\n"
            << "* " << mulTime << "\n"
            << "/ " << divTime << "\n";

    return result.str();
}

void WriteToFile(std::string path, std::string fileContent)
{
    std::ofstream out(path);
    out << fileContent;
    out.close();
}

int main()
{
    int repsPerTest = 10;

    float min = std::numeric_limits<float>::min();
    float max = std::numeric_limits<float>::max();

    std::string resultSISD_2048 = PerformTestsSISD(2048, repsPerTest, min, max);
    std::string resultSISD_4096 = PerformTestsSISD(4096, repsPerTest, min, max);
    std::string resultSISD_8192 = PerformTestsSISD(8192, repsPerTest, min, max);

    std::cout << resultSISD_2048 << std::endl;
    std::cout << resultSISD_4096 << std::endl;
    std::cout << resultSISD_8192 << std::endl;

    std::string resultSIMD_2048 = PerformTestsSIMD(2048, repsPerTest, min, max);
    std::string resultSIMD_4096 = PerformTestsSIMD(4096, repsPerTest, min, max);
    std::string resultSIMD_8192 = PerformTestsSIMD(8192, repsPerTest, min, max);

    std::cout << resultSIMD_2048 << std::endl;
    std::cout << resultSIMD_4096 << std::endl;
    std::cout << resultSIMD_8192 << std::endl;

    WriteToFile("result_SISD.txt", resultSISD_2048 + "\n" + resultSISD_4096 + "\n" + resultSISD_8192);
    WriteToFile("result_SIMD.txt", resultSIMD_2048 + "\n" + resultSIMD_4096 + "\n" + resultSIMD_8192);

    return 0;
}